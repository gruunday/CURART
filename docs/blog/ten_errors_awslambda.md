# Ten Errors Getting OpenCV on AWS Lambda

In this blog we are exploring the use of Amazon Web Services’ (AWS) function as a service (FAAS) feature called lambda functions. This has presented multiple problems in this project and has set the project back a month. The following blog will be a breakdown of errors encountered and how they have been overcome or how a workaround has come about. 
	
The design was conceived with no prior hands on experience with AWS Lambda but a solid linux and development operations (DevOps) knowledge, including container technologies such as Docker. It was decided that one particularly intensive function would be done by a lambda function. This would mean that if there were to be a heavy amount of users on the application this function would not become a bottleneck and the application would scale out to huge numbers. Without this the application would remain a research “toy” on a server and work for demonstration purposes but not scale. 
	
One of the very first errors encountered with this project was attempting to compile opencv locally on a local machine. Compilation was necessary because of the extra modules that are not included in the default installation of opencv, a module vital for the success of this project. The module in question is xfeatures, containing an algorithm called SIFT. It is not included in the default package because it is a patented, non-free algorithm. It is to be used only for research and not commercial purposes. This is perfect for this project’s requirements but requires you to compile opencv with the OPENCV_ENABLE_NON_FREE flag set to true.
	
Another set back was encountered here when there were multiple versions of python on the local machine and the discovery built into cmake was thrown off. Initially it found no valid versions of python and after several days* of work, cmake discovered python2.7. With only nine months at the time of writing [1] until the end of life of python2 this was not going to be an option to continue with this version of python and the decision was made to keep trying to attempt to get cmake to recognise python3. The end solution to this problem was to backup all important files and completely wipe the local machine clean and install python once and correctly. This solved this issue and cmake could discover python3.
	
Once opencv was working locally, mockup functions were designed and code to create image “fingerprints” were created. These worked well and quickly to find an image across a file system. Following this, the attempt to implement the now working code on AWS Lambda was undertaken. No previous knowledge was known about lambda, and subsequently there were days* of trial and error until a working hello world toy was created. The learning curve for this was steep as there is a lot of documentation but there are a lot of prerequisites to know before any working solution can take shape.
	
During the next phase it was a steep learning curve about what it was going to take to package the opencv library and ship it to the lambda function. Hundreds of articles were consulted to attempt to find a working solution. Finally one was found in the form of a bash script. After reading this script it became apparent the steps it was taking, and although it did not suit my needs as a whole it had two beneficial lines.[2] From this it was apparent what files needed to be included in the package along with my python function. A simple error that stunted progress was a misconfiguration between the name of the python file in this package and the name of the function on the AWS Lambda console page. 
	
An error in thinking that should have been caught sooner was the fact that the package of python code and the opencv library that had just been created was compiled for the local machine and would not run on AWS Lambda. After reading a readme about a project that had attempted this previous you can create an Elastic Compute Cloud (EC2) from Amazon and compile the code there and package that for the lambda function. The documentation followed specifically cited a C4.2xlarge Amazon Linux machine.[3]
	
Once the software was compiled and packaged there was an error encountered while uploading this to the lambda function. This was cited as the package being too large. Packages for AWS Lambda have to be less that 50M, this package was coming to 58M. The workaround for this was going back to the large library of opencv functions, many of which were unnecessary. They were each looked at and modules that were not used were removed from the opencv_contrib repo on the local machine and opencv was re-compiled without these once more. This brought the package size down to 48M, enough to test it on the lambda function. 

This did not work and had similar issues as before with the packages that were compiled for the local machine. The errors were in relation to shared packages not being available. It was then eventually found there is one correct instance where you can compile packages for AWS Lambda and that was found in the AWS documentation.[4] It is a premade AMI. Once again the instance was destroyed and an effort to start over and reinstall the correct machine was made.

This correct instance was then used to attempt a compilation although very slow. But because this instance was restricted to 1GB of memory, the compilation could not complete with an “out of virtual memory” error at 86% completion. A local docker container was also used trying to compile with the amazon linux docker image. This compiled successfully and looked promising and working locally. But when uploaded to a Lambda function this failed due to not having access to shared libraries that it had locally that is did not have in the Lambda function as with all other versions not compiled on the specific AMI. 
It is at this point that we stand at the point of no return. We have fallen dangerously close to the deadline and we have to make a sacrifice that this is not worth continuing with lambda functions because the risk of not succeeding is too high and for the deadline there needs to be working software. If time permits we may consider coming back but for now AWS lambda functions are off the table in this project.
For now a plan has been put in place to create a custom docker image based off ubuntu with python and opencv. This means that the project can run in a docker container and possibly be managed by a container management system like kubernetes. This would allow scaling and growth that the project had intended to have originally and may be a solution just as good.
 
\* We do not work full time on the project we have classes and assignments that have to take precedence

1. [https://hg.python.org/peps/rev/76d43e52d978](https://hg.python.org/peps/rev/76d43e52d978)
2. [https://github.com/aeddi/aws-lambda-python-opencv/blob/master/build.sh (lines37-38)](https://github.com/aeddi/aws-lambda-python-opencv/blob/master/build.sh)
3. [https://github.com/aeddi/aws-lambda-python-opencv](https://github.com/aeddi/aws-lambda-python-opencv)
4. [https://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html](https://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html)
